# Lumina-Layers

一个探索**分层光学混色**技术的实验性 FDM 引擎。  
从 CMYK 像素画起步，逐步发展为通用的多材料照片处理器。

**[📖 English Version / 英文文档](README.md)**

---

## 🛑 仅限非商业用途

本软件及其生成的任何模型均采用 **CC BY-NC-SA 4.0** 许可协议。

- ❌ **禁止**出售生成的 STL/3MF 文件
- ❌ **禁止**出售使用本工具生成的实体打印品
- ❌ **禁止**将本工具打包成付费服务

如需商业授权，请联系作者。

---

## 📖 项目概述

**Lumina-Layers** 旨在打通数字像素与物理耗材之间的鸿沟。

传统的多色浮雕工具依赖理论上的"透光距离"(TD) 数值，但由于耗材批次差异、喷嘴温度变化或切片逻辑不同，这些理论值往往无法准确反映实际效果。Lumina-Layers 采用**闭环校准系统**：通过扫描实际打印的色彩矩阵，为你的打印机硬件构建专属的"真实值"查找表 (LUT)，确保像素画和浮雕模型的色彩精准还原。

---

## 🔄 闭环工作流程

**Lumina Studio v1.2** 将三个专用模块整合为一个统一的应用程序：

### 📐 模块一：校准板生成器
生成精密的校准板，用于实际测试耗材混色效果。

- **1024色矩阵**：4种基础耗材在5层（0.4mm）中的全排列组合
- **双色彩模式**：支持 **CMYW**（青/品红/黄/白）和 **RYBW**（红/黄/蓝/白）两种模式
- **朝下打印优化**：将观看面直接打印在热床上，获得光滑表面
- **实心底板**：自动生成1.6mm不透明底板，确保色彩一致性和结构强度
- **防重叠几何**：对体素应用0.02mm微收缩，防止切片器线宽冲突

### 🎨 模块二：颜色提取器
将打印机的物理现实数字化。

- **计算机视觉**：使用透视变换和镜头畸变校正自动对齐网格
- **模式感知对齐**：根据所选模式（CMYW 或 RYBW）自动调整角点颜色顺序
- **数字孪生**：从打印件中提取 RGB 数值，生成 `.npy` 格式的 LUT 文件
- **人工辅助**：交互式探针工具允许手动验证和修正特定色块读数（如去除眩光/阴影）

### 💎 模块三：图像转换器
使用校准数据将图像转换为可打印的3D模型。

- **KD-Tree 颜色匹配**：将图像像素映射到 LUT 中的实际可打印颜色
- **实时3D预览**：交互式 WebGL 预览，显示真实匹配颜色 - 可旋转、缩放、打印前检查
- **结构选项**：双面（钥匙扣）或单面（浮雕）模式
- **智能背景移除**：自动透明度检测，可调容差
- **正确的3MF命名**：对象按颜色命名（如 "Cyan"、"Magenta"），而非 "geometry_0"，方便切片器识别

---

## ✨ v1.2 新功能

| 功能 | 说明 |
|------|------|
| 🔧 **修复3MF命名** | 切片器现在显示正确的颜色名称（White, Cyan, Magenta...） |
| 🎨 **双色彩模式** | 完整支持 CMYW 和 RYBW 两种色彩系统 |
| 🎮 **实时3D预览** | 交互式预览，显示实际 LUT 匹配颜色 |
| 🌐 **双语界面** | 界面全程中英文标签 |
| 📏 **优化间隙** | 默认间隙改为0.82mm，适配标准线宽 |
| 📦 **统一应用** | 三个工具合并为单一的 `LuminaStudio.py` |

---

## 🗺️ 开发路线图

### 第一阶段：基础功能 ✅ **已完成**
> 目标：像素画和简单图形

- ✅ CMYW/RYBW 固定混色
- ✅ 基于整数的 "Slab" 几何
- ✅ 实心底板生成
- ✅ 闭环校准系统
- ✅ 真实颜色的实时3D预览

### 第二阶段：漫画模式（单色）🚧 **进行中**
> 目标：漫画分镜、水墨画、高对比度插图

- 逻辑：使用厚度灰度的黑白分层（透光浮雕逻辑）
- 技术：模拟网点（Ben-Day dots）

### 第三阶段：全彩照片引擎
> 目标：照片、动漫插图

- 逻辑：动态调色板支持（4/6/8色）
- 技术：
  - 高级抖动算法（Floyd-Steinberg/Atkinson）模拟渐变
  - LAB 色彩空间整合，提升感知匹配度

### 第四阶段：扩展色彩模式
> 目标：专业多材料打印

- 6色扩展模式
- 8色专业模式
- 拼豆模式

---

## 🛠️ 安装

**克隆仓库**
```bash
git clone https://github.com/MOVIBALE/Lumina-Layers.git
cd Lumina-Layers
```

**安装依赖**
```bash
pip install -r requirements.txt
```

---

## 🚀 使用指南

### 快速启动
```bash
python LuminaStudio.py
```
这将启动包含所有三个模块的 Web 界面。

---

### 第一步：生成校准板

1. 打开 **📐 校准板** 标签页
2. 选择色彩模式：
   - **RYBW**（红/黄/蓝/白）- 传统三原色
   - **CMYW**（青/品红/黄/白）- 印刷色彩，色域更广
3. 调整色块尺寸（默认：5mm）和间隙（默认：0.82mm）
4. 点击 **生成** 并下载 `.3mf` 文件

**打印设置：**
- 层高：0.08mm（色彩层），底板可使用 0.2mm
- 耗材槽位必须与所选模式匹配

| 模式 | 槽位1 | 槽位2 | 槽位3 | 槽位4 |
|------|-------|-------|-------|-------|
| RYBW | 白色 | 红色 | 黄色 | 蓝色 |
| CMYW | 白色 | 青色 | 品红 | 黄色 |

---

### 第二步：提取颜色

1. 打印校准板并拍照（正面朝上，光线均匀）
2. 打开 **🎨 颜色提取** 标签页
3. **选择与校准板相同的色彩模式**
4. 上传照片
5. 按顺序点击四个角的色块：

| 模式 | 角点1（左上） | 角点2（右上） | 角点3（右下） | 角点4（左下） |
|------|---------------|---------------|---------------|---------------|
| RYBW | ⬜ 白色 | 🟥 红色 | 🟦 蓝色 | 🟨 黄色 |
| CMYW | ⬜ 白色 | 🔵 青色 | 🟣 品红 | 🟨 黄色 |

6. 如需要，调整校正滑块
7. 点击 **提取** 并下载 `my_printer_lut.npy`

---

### 第三步：转换图像

1. 打开 **💎 图像转换** 标签页
2. 上传 `.npy` LUT 文件
3. 上传要转换的图像（像素画效果最佳）
4. **选择与 LUT 相同的色彩模式**
5. 选择结构类型：
   - **双面** - 适合钥匙扣（两面都有图像）
   - **单面** - 适合浮雕/透光浮雕风格
6. 点击 **生成**
7. 在交互式3D查看器中预览
8. 下载 `.3mf` 文件

---

## 🧱 技术栈

| 组件 | 技术 |
|------|------|
| 核心逻辑 | Python (NumPy 体素操作) |
| 几何引擎 | Trimesh (网格生成与导出) |
| UI框架 | Gradio 4.0+ |
| 视觉处理 | OpenCV (透视变换与颜色提取) |
| 颜色匹配 | SciPy KDTree |
| 3D预览 | Gradio Model3D (GLB格式) |

---

## 📄 许可证

本项目采用 **知识共享 署名-非商业性使用-相同方式共享 4.0 国际许可协议 (CC BY-NC-SA 4.0)**。

- ✅ **署名**：必须注明原作者
- ❌ **非商业性使用**：不可用于商业目的
- 🔄 **相同方式共享**：修改后必须以相同许可证分发

---

<div align="center">

Made with ❤️ by [MIN]

**⭐ 如果觉得有用，请给个 Star！**

</div>
